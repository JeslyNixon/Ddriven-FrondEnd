<div class="user-management-container">
  <!-- Header -->
  <div class="page-header">
    <h1>User Management</h1>
    <button class="btn btn-primary" *ngIf="permissionService.hasPermission('user.create')" (click)="openCreateUserModal()">
      <span class="icon">+</span> Create User
    </button>
  </div>

  <!-- Filters and Search -->
  <div class="filters-container">
    <div class="search-box">
      <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()" placeholder="Search by name or email..."
        class="search-input" />
      <button (click)="onSearch()" class="btn-search">Search</button>
    </div>

    <div class="filter-group">
      <label>Role:</label>
      <select [(ngModel)]="roleFilter" (change)="onRoleFilterChange()" class="filter-select">
        <option value="all">All Roles</option>
        <option *ngFor="let role of allRoles" [value]="role.name">
          {{ getRoleDisplayName(role) }}
        </option>
      </select>
    </div>

    <div class="filter-group">
      <label>Sort by:</label>
      <select [(ngModel)]="sortBy" (change)="onSortChange()" class="filter-select">
        <option value="created_at">Created Date</option>
        <option value="name">Name</option>
        <option value="email">Email</option>
      </select>
      <button (click)="toggleSortOrder()" class="btn-sort">
        {{ sortOrder === 'asc' ? '↑' : '↓' }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading users...</p>
  </div>

  <!-- Users Table -->
  <div *ngIf="!isLoading" class="table-container">
    <table class="users-table">
      <thead>
        <tr>
          <!-- <th>ID</th> -->
          <th class="expand-col"></th>
          <th>Name</th>
          <th class="hide-mobile">Email</th>
          <th class="hide-mobile">Roles</th>
          <th class="hide-mobile">Created</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let user of users">
          <!-- Main Row -->
          <tr [class.deleted]="user.deleted_at">
            <td class="expand-col">
              <button type="button" class="btn-expand" (click)="toggleExpand(user.id); $event.stopPropagation()"
                [class.expanded]="isExpanded(user.id)">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </button>
            </td>
            <td>
              <div class="user-name">
                {{ user.name }}
                <span *ngIf="user.deleted_at" class="deleted-badge">Deleted</span>
              </div>
            </td>
            <td class="hide-mobile">
              <div class="user-email">
                {{ user.email }}
                <span *ngIf="user.email_verified_at" class="verified-icon" title="Email verified">✓</span>
              </div>
            </td>
            <td class="hide-mobile">
              <div class="roles-cell">
                <span *ngFor="let role of user.roles" class="role-badge" [ngClass]="getRoleBadgeClass(role.name)">{{
                  getRoleDisplayName(role) }}</span>
                <span *ngIf="!user.roles || user.roles.length === 0" class="no-roles">No roles</span>
              </div>
            </td>
            <td class="hide-mobile">{{ formatDate(user.created_at) }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon"  *ngIf="permissionService.hasPermission('user.update')"  (click)="openEditUserModal(user)" title="Edit">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M13 2l3 3-9 9H4v-3l9-9zM11 4l3 3" stroke="currentColor" stroke-width="1.5"
                      stroke-linecap="round" />
                  </svg>
                </button>
                <button class="btn-icon btn-danger"  *ngIf="permissionService.hasPermission('user.delete')"  (click)="openDeleteModal(user)" title="Delete">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M2 4h14M6 4V2h6v2M7 8v5M11 8v5M3 4l1 11a1 1 0 001 1h8a1 1 0 001-1l1-11"
                      stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <!-- Expanded Details Row (Mobile Only) -->
          <tr class="expanded-row" *ngIf="isExpanded(user.id)">
            <td colspan="3">
              <div class="expanded-details">
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                      <path d="M2 4h12v8a2 2 0 01-2 2H4a2 2 0 01-2-2V4zM2 4l6 4 6-4" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" />
                    </svg>
                    Email
                  </div>
                  <div class="detail-value">
                    {{ user.email }}
                    <span *ngIf="user.email_verified_at" class="verified-icon" title="Email verified">✓</span>
                  </div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                      <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM3 14c0-2.21 2.24-4 5-4s5 1.79 5 4" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" />
                    </svg>
                    Roles
                  </div>
                  <div class="detail-value">
                    <div class="roles-cell">
                      <span *ngFor="let role of user.roles" class="role-badge"
                        [ngClass]="getRoleBadgeClass(role.name)">{{ getRoleDisplayName(role) }}</span>
                      <span *ngIf="!user.roles || user.roles.length === 0" class="no-roles">No roles</span>
                    </div>
                  </div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                      <rect x="2" y="3" width="12" height="11" rx="1" stroke="currentColor" stroke-width="1.5" />
                      <path d="M5 1v3M11 1v3M2 7h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                    </svg>
                    Created
                  </div>
                  <div class="detail-value">{{ formatDate(user.created_at) }}</div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>

        <tr *ngIf="users.length === 0">
          <td colspan="6" class="no-data">
            <div class="no-data-message">
              <p>No users found</p>
              <button class="btn btn-primary" (click)="openCreateUserModal()">
                Create First User
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && users.length > 0" class="pagination-container">
    <div class="pagination-info">
      {{ showingText }}
    </div>
    <div class="pagination-controls">
      <button (click)="previousPage()" [disabled]="currentPage === 1" class="btn btn-pagination">
        Previous
      </button>

      <button *ngFor="let page of pageNumbers" (click)="goToPage(page)" [class.active]="page === currentPage"
        class="btn btn-page-number">
        {{ page }}
      </button>

      <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn btn-pagination">
        Next
      </button>
    </div>
  </div>
</div>

<!-- Create/Edit User Modal -->
<div *ngIf="showUserModal" class="modal-overlay" (click)="closeUserModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Edit User' : 'Create New User' }}</h2>
      <button class="btn-close" (click)="closeUserModal()">×</button>
    </div>

    <div class="modal-body">
      <form class="user-form">
        <!-- Name Field -->
        <div class="form-group">
          <label for="name">Full Name <span class="required">*</span></label>
          <input type="text" #nameInput id="name" [(ngModel)]="userForm.name" name="name" placeholder="Enter full name"
            [class.error]="formErrors.name" />
          <span *ngIf="formErrors.name" class="error-message">
            {{ formErrors.name }}
          </span>
        </div>

        <!-- Email Field -->
        <div class="form-group">
          <label for="email">Email Address <span class="required">*</span></label>
          <input type="email" id="email" [(ngModel)]="userForm.email" name="email" placeholder="Enter email address"
            [class.error]="formErrors.email" />
          <span *ngIf="formErrors.email" class="error-message">
            {{ formErrors.email }}
          </span>
        </div>

        <!-- Password Field -->
        <div class="form-group">
         <label for="password">
  Password
  <ng-container *ngIf="!isEditMode">
    <span class="required">*</span>
  </ng-container>
  <span *ngIf="isEditMode"> (leave blank to keep current)</span>
</label>
          <input type="password" id="password" [(ngModel)]="userForm.password" name="password"
            [placeholder]="isEditMode ? 'Enter new password (optional)' : 'Enter password (min 8 characters)'"
            [class.error]="formErrors.password" />
          <span *ngIf="formErrors.password" class="error-message">
            {{ formErrors.password }}
          </span>
        </div>

        <!-- Confirm Password Field -->
        <div class="form-group" *ngIf=" userForm.password">
          <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
          <input type="password" id="confirmPassword" [(ngModel)]="userForm.confirmPassword" name="confirmPassword"
            placeholder="Re-enter password" [class.error]="formErrors.confirmPassword" />
          <span *ngIf="formErrors.confirmPassword" class="error-message">
            {{ formErrors.confirmPassword }}
          </span>
        </div>

        <!-- Role Selection -->
        <div class="form-group">
          <label for="role">Select Role <span class="required">*</span></label>
          <select id="role" [(ngModel)]="userForm.role_id" name="role" class="form-select"
            [class.error]="formErrors.role">
            <option [ngValue]="null" disabled>-- Select a role --</option>
            <option *ngFor="let role of allRoles" [ngValue]="role.id">
              {{ getRoleDisplayName(role) }}
            </option>
          </select>
          <span *ngIf="formErrors.role" class="error-message">
            {{ formErrors.role }}
          </span>
          <div *ngIf="isLoadingRoles" class="loading-roles-inline">
            Loading roles...
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-primary" (click)="saveUser()">
        {{ isEditMode ? 'Update User' : 'Create User' }}
      </button>
      <button class="btn btn-secondary" (click)="closeUserModal()">
        Cancel
      </button>
      
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="btn-close" (click)="closeDeleteModal()">×</button>
    </div>

    <div class="modal-body">
      <p class="delete-message">
        Are you sure you want to delete the user
        <strong>{{ userToDelete?.name }}</strong>?
      </p>
      <p class="delete-warning">
        This action cannot be undone.
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteModal()">
        Cancel
      </button>
      <button class="btn btn-danger" (click)="confirmDeleteUser()">
        Delete User
      </button>
    </div>
  </div>
</div>
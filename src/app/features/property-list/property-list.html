<div class="properties-container">
  
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Property Inspections</h1>
      <p class="subtitle">Manage and view all vacant land inspections</p>
    </div>
    <div class="header-right">
      <button class="btn-primary" *ngIf="permissionService.hasPermission('project.create')" (click)="createNewProperty()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        New Project
      </button>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="filters-section">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input 
        type="text" 
        placeholder="Search by project ID, owner, bank, or address..."
        [(ngModel)]="searchTerm"
        (input)="onSearch()">
    </div>

    <div class="filter-group">
      <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="filter-select">
        <option value="all">All Status</option>
        <option value="draft">Draft</option>
        <option value="completed">Completed</option>
        <option value="approved">Approved</option>
      </select>

      <select [(ngModel)]="sortBy" (change)="onSortChange()" class="filter-select">
        <option value="created_at">Created Date</option>
        <option value="updated_at">Updated Date</option>
        <option value="project_id">Project ID</option>
        <option value="owner_name">Owner Name</option>
      </select>

      <button class="btn-icon" (click)="toggleSortOrder()" title="Toggle sort order">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" *ngIf="sortOrder === 'asc'">
          <path d="M10 15V5M6 9l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" *ngIf="sortOrder === 'desc'">
          <path d="M10 5v10m-4-4l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="export-buttons">
        <button class="btn-secondary btn-sm" (click)="exportToExcel()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M14 10v2.667A1.333 1.333 0 0112.667 14H3.333A1.333 1.333 0 012 12.667V10M11.333 6L8 2.667 4.667 6M8 3v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          Excel
        </button>
        <button class="btn-secondary btn-sm" (click)="exportToPDF()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M14 10v2.667A1.333 1.333 0 0112.667 14H3.333A1.333 1.333 0 012 12.667V10M11.333 6L8 2.667 4.667 6M8 3v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Toolbar -->
  <div class="bulk-actions-toolbar" *ngIf="canShowCheckboxes()">
    <div class="bulk-actions-left">
      <label class="checkbox-label">
        <input 
          type="checkbox" 
          [checked]="isAllSelected()"
          [indeterminate]="isSomeSelected()"
          (change)="toggleSelectAll()"
          class="checkbox-input">
        <span class="checkbox-text">
          {{ selectedCount > 0 ? selectedCount + ' selected' : 'Select all completed' }}
        </span>
      </label>
    </div>
    
    <div class="bulk-actions-right" *ngIf="selectedCount > 0">
      <button 
        class="btn-approve" 
         *ngIf="permissionService.hasPermission('project.approve')"
        (click)="openBulkApprovalModal()"
        [disabled]="isApproving">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" *ngIf="!isApproving">
          <path d="M13 4L6 11 3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="spinner-sm" *ngIf="isApproving"></span>
        {{ isApproving ? 'Approving...' : 'Approve Selected (' + selectedCount + ')' }}
      </button>
      
      <button class="btn-text" (click)="clearSelection()">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading properties...</p>
  </div>

  <!-- Properties Table -->
  <div class="table-container" *ngIf="!isLoading && properties.length > 0">
    <table class="properties-table">
      <thead>
        <tr>
          <th class="checkbox-col" *ngIf="canShowCheckboxes()"></th>
          <th class="expand-col"></th>
          <th>Project ID</th>
          <th>Status</th>
          <th class="hide-mobile">Owner</th>
          <th class="hide-mobile">Bank</th>
          <th class="hide-mobile">Address</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let property of properties">
          <!-- Main Row -->
          <tr class="table-row">
            <!-- Checkbox Column -->
            <td class="checkbox-col" *ngIf="canShowCheckboxes()">
              <input 
                type="checkbox" 
                *ngIf="isPropertyCompleted(property)"
                [checked]="isPropertySelected(property.id)"
                (change)="toggleSelectProperty(property.id)"
                (click)="$event.stopPropagation()"
                class="row-checkbox">
            </td>
            
            <td class="expand-col">
              <button 
                type="button"
                class="btn-expand" 
                (click)="toggleExpand(property.id); $event.stopPropagation()"
                [class.expanded]="isExpanded(property.id)">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </td>
            <td class="project-id">
              <strong>{{ property.project_id }}</strong>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(property.status)">
                {{ getStatusLabel(property.status) }}
              </span>
            </td>
            <td class="owner-cell hide-mobile">
              <div class="cell-with-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM3 14c0-2.21 2.24-4 5-4s5 1.79 5 4" stroke="currentColor" stroke-width="1.5"
                    stroke-linecap="round" />
                </svg>
                <span>{{ property.owner_name }}</span>
              </div>
            </td>
            <td class="bank-cell hide-mobile">
              <div class="cell-with-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M2 6h12M2 6l2-4h8l2 4M2 6v6a2 2 0 002 2h8a2 2 0 002-2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>{{ property.bank }}</span>
              </div>
            </td>
            <td class="address-cell hide-mobile">
              <div class="cell-with-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M13 6.5L8 2 3 6.5V13a1 1 0 001 1h8a1 1 0 001-1V6.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>{{ property.site_address }}</span>
              </div>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <!-- Approve Button (only for completed status) -->
                <button 
                  class="btn-icon btn-approve-single" 
                   *ngIf="permissionService.hasPermission('project.approve') && isPropertyCompleted(property)"
                  (click)="openSingleApprovalModal(property)" 
                  [disabled]="isApproving"
                  title="Approve">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M15 5L7 13 3 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                
                <button class="btn-icon"  *ngIf="permissionService.hasPermission('project.update')" (click)="editProperty(property.id)" title="Edit">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M13 2l3 3-9 9H4v-3l9-9zM11 4l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
                <button class="btn-icon btn-danger"  *ngIf="permissionService.hasPermission('project.delete')" (click)="openDeleteModal(property)" title="Delete">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M2 4h14M6 4V2h6v2M7 8v5M11 8v5M3 4l1 11a1 1 0 001 1h8a1 1 0 001-1l1-11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          
          <!-- Expanded Details Row (Mobile Only) -->
          <tr class="expanded-row" *ngIf="isExpanded(property.id)">
            <td [attr.colspan]="canShowCheckboxes() ? 5 : 4">
              <div class="expanded-details">
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM3 14c0-2.21 2.24-4 5-4s5 1.79 5 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    Owner
                  </div>
                  <div class="detail-value">{{ property.owner_name }}</div>
                </div>
                
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M2 6h12M2 6l2-4h8l2 4M2 6v6a2 2 0 002 2h8a2 2 0 002-2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    Bank
                  </div>
                  <div class="detail-value">{{ property.bank }}</div>
                </div>
                
                <div class="detail-item">
                  <div class="detail-label">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13 6.5L8 2 3 6.5V13a1 1 0 001 1h8a1 1 0 001-1V6.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    Address
                  </div>
                  <div class="detail-value">{{ property.site_address }}</div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && properties.length === 0">
    <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
      <circle cx="60" cy="60" r="50" fill="#F3F4F6"/>
      <path d="M40 60h40M60 40v40" stroke="#9CA3AF" stroke-width="4" stroke-linecap="round"/>
    </svg>
    <h3>No properties found</h3>
    <p *ngIf="searchTerm || statusFilter !== 'all'">Try adjusting your filters or search criteria</p>
    <p *ngIf="!searchTerm && statusFilter === 'all'">Get started by creating your first property inspection</p>
    <button class="btn-primary" (click)="createNewProperty()">Create New Project</button>
  </div>

  <!-- Results Count -->
  <div class="results-info">
    <span class="count">{{ showingText }}</span>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="!isLoading && totalItems > 0">
    <button 
      class="btn-secondary btn-sm" 
      (click)="previousPage()" 
      [disabled]="currentPage === 1">
      Previous
    </button>
    
    <div class="page-numbers">
      <button 
        *ngFor="let page of pageNumbers"
        class="page-btn"
        [class.active]="page === currentPage"
        (click)="goToPage(page)">
        {{ page }}
      </button>
    </div>
    
    <button 
      class="btn-secondary btn-sm" 
      (click)="nextPage()" 
      [disabled]="currentPage === totalPages">
      Next
    </button>
  </div>

  <!-- Inspector Declaration Modal -->
  <div class="modal-overlay" *ngIf="showApprovalModal" (click)="closeApprovalModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ approvalMode === 'single' ? 'Approve Property Inspection' : 'Bulk Approve Properties' }}</h2>
        <button class="modal-close-btn" (click)="closeApprovalModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Single Property Details -->
        <div class="property-details-section" *ngIf="approvalMode === 'single' && selectedPropertyForApproval">
          <h3>Property Details</h3>
          <div class="details-grid">
            <div class="detail-row">
              <span class="detail-label">Project ID:</span>
              <span class="detail-value">{{ selectedPropertyForApproval.project_id }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Owner Name:</span>
              <span class="detail-value">{{ selectedPropertyForApproval.owner_name }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Bank:</span>
              <span class="detail-value">{{ selectedPropertyForApproval.bank }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Address:</span>
              <span class="detail-value">{{ selectedPropertyForApproval.site_address }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="status-badge" [ngClass]="getStatusClass(selectedPropertyForApproval.status)">
                {{ getStatusLabel(selectedPropertyForApproval.status) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Bulk Approval Summary -->
        <div class="bulk-summary-section" *ngIf="approvalMode === 'bulk'">
          <div class="summary-card">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" class="summary-icon">
              <circle cx="24" cy="24" r="20" fill="#E8F5E9"/>
              <path d="M34 18L20 32L14 26" stroke="#4CAF50" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>{{ selectedCount }} {{ selectedCount === 1 ? 'Property' : 'Properties' }} Selected</h3>
            <p class="summary-text">You are about to approve {{ selectedCount }} property inspection{{ selectedCount > 1 ? 's' : '' }}.</p>
          </div>
        </div>

        <!-- Inspector Declaration -->
        <div class="inspector-declaration">
          <h3>Inspector Declaration</h3>
          <p class="declaration-text">
            I hereby declare that the information provided in {{ approvalMode === 'single' ? 'this inspection' : 'these inspections' }} 
            is accurate to the best of my knowledge and based on {{ approvalMode === 'single' ? 'my' : 'our' }} physical inspection 
            of the {{ approvalMode === 'single' ? 'property' : 'properties' }}.
          </p>
          
          <div class="form-field">
            <label for="inspectorName">Inspector Name <span class="required">*</span></label>
            <input 
              type="text" 
              id="inspectorName"
              [(ngModel)]="inspectorName"
              placeholder="Enter your full name"
              class="form-input"
              [class.error]="inspectorNameError"
            />
            <span class="error-message" *ngIf="inspectorNameError">{{ inspectorNameError }}</span>
          </div>

          <div class="signature-area">
            <label>Inspector Signature <span class="required">*</span></label>
            <div class="signature-controls">
              <button 
                type="button"
                class="signature-tab"
                [class.active]="signatureMode === 'draw'"
                (click)="setSignatureMode('draw')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M12 2l2 2-8 8H4v-2l8-8zM10 4l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Draw
              </button>
              <button 
                type="button"
                class="signature-tab"
                [class.active]="signatureMode === 'upload'"
                (click)="setSignatureMode('upload')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M14 10v2.667A1.333 1.333 0 0112.667 14H3.333A1.333 1.333 0 012 12.667V10M11.333 6L8 2.667 4.667 6M8 3v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Upload
              </button>
            </div>

            <!-- Draw Mode -->
            <div class="signature-box" [class.error]="signatureError" *ngIf="signatureMode === 'draw'">
              <canvas 
                #signatureCanvas
                (mousedown)="startDrawing($event)"
                (mousemove)="draw($event)"
                (mouseup)="stopDrawing()"
                (mouseleave)="stopDrawing()"
                (touchstart)="startDrawing($event)"
                (touchmove)="draw($event)"
                (touchend)="stopDrawing()"
                class="signature-canvas">
              </canvas>
              <p class="signature-hint" *ngIf="!hasSignature">Draw your signature above</p>
            </div>

            <!-- Upload Mode -->
            <div class="signature-box upload-box" [class.error]="signatureError" *ngIf="signatureMode === 'upload'">
              <input 
                type="file" 
                #signatureFileInput
                (change)="onSignatureFileSelected($event)"
                accept="image/png,image/jpeg,image/jpg"
                class="signature-file-input"
                id="signatureFileInput">
              
              <div class="upload-area" *ngIf="!uploadedSignaturePreview" (click)="signatureFileInput.click()">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                  <path d="M42 30v8a4 4 0 01-4 4H10a4 4 0 01-4-4v-8M34 16L24 6 14 16M24 6v24" stroke="#9CA3AF" stroke-width="3" stroke-linecap="round"/>
                </svg>
                <p class="upload-text">Click to upload signature</p>
                <p class="upload-hint">PNG or JPG (max 2MB)</p>
              </div>

              <div class="signature-preview" *ngIf="uploadedSignaturePreview">
                <img [src]="uploadedSignaturePreview" alt="Uploaded signature">
              </div>
            </div>

            <div class="signature-actions" *ngIf="hasSignature || uploadedSignaturePreview">
              <button 
                type="button"
                class="btn-clear-signature" 
                (click)="clearSignature()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M2 4h14M6 4V2h6v2M7 8v5M11 8v5M3 4l1 11a1 1 0 001 1h8a1 1 0 001-1l1-11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Clear Signature
              </button>
            </div>

            <span class="error-message" *ngIf="signatureError">{{ signatureError }}</span>
          </div>

          <div class="form-field">
            <label>Date</label>
            <input 
              type="date" 
              [value]="currentDate"
              readonly
              class="form-input readonly"
            />
          </div>

          <div class="declaration-checkbox">
            <label class="checkbox-container">
              <input 
                type="checkbox" 
                [(ngModel)]="declarationAccepted"
                class="checkbox-input"
              />
              <span class="checkmark"></span>
              <span class="checkbox-label">
                I confirm that I have thoroughly inspected the {{ approvalMode === 'single' ? 'property' : 'properties' }} 
                and all information provided is accurate and complete.
              </span>
            </label>
            <span class="error-message" *ngIf="declarationError">{{ declarationError }}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeApprovalModal()" [disabled]="isApproving">
          Cancel
        </button>
        <button 
          class="btn-primary" 
          (click)="confirmApproval()" 
          [disabled]="isApproving">
          <span class="spinner-sm" *ngIf="isApproving"></span>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" *ngIf="!isApproving">
            <path d="M16 6L8 14 4 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ isApproving ? 'Approving...' : (approvalMode === 'single' ? 'Approve Property' : 'Approve All Selected') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="btn-close" (click)="closeDeleteModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <p class="delete-message">
        Are you sure you want to delete the property
        <strong>{{ propertyToDelete?.project_id }}</strong>?
      </p>
      <p class="delete-warning">
        This action cannot be undone.
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteModal()">
        Cancel
      </button>
      <button class="btn btn-danger" (click)="confirmDelete()">
        Delete 
      </button>
    </div>
  </div>
</div>